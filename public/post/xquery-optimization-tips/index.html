
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Xquery Optimization Tips - Jake Trent</title>

  <meta name="author" content="https://plus.google.com/115032056022257436849">
  
  <meta name="description" content="My first xquery experience has been on the MarkLogic platform. The project that we just released was written entirely in xquery and on that platform &hellip;">
  <meta name="keywords" content="marklogic, performance, xquery">
  <meta name="copyright" content="http://creativecommons.org/licenses/by/3.0/us/" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Xquery Optimization Tips" />
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://jaketrent.com/post/xquery-optimization-tips/" />
  <meta property="og:description" content="My first xquery experience has been on the MarkLogic platform. The project that we just released was written entirely in xquery and on that platform &hellip;" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Xquery Optimization Tips" />
  <meta name="twitter:description" content="My first xquery experience has been on the MarkLogic platform. The project that we just released was written entirely in xquery and on that platform &hellip;" />
  

  
  <link rel="canonical" href="http://jaketrent.com/post/xquery-optimization-tips/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Jake Trent" type="application/atom+xml">
  <meta name="google-site-verification" content="uvx7BhaUTNz29nQgydsFPRsErfqYBhPEV_svnHvW7H0" />

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16224416-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="container">
    <div class="sidebar">
      <section class="logo">
  <header class="logo-header">
    <h2 class="logo-title">
      <a class="logo-link" href="/">
        <span class="logo-img"></span>
      </a>
    </h2>
  </header>
</section>

      <nav class="main-nav" role="navigation"><ul class="main-nav-list">
  <li class="main-nav-item">
    <a class="main-nav-link" href="/">Blog</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="/work">Work</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="/books">Books</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="https://github.com/jaketrent">Github</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="http://www.linkedin.com/in/jaketrent">LinkedIn</a>
  </li>
</ul>
</nav>
    </div>
    <div class="content">
      <div>
<article class="entry entry-detail" role="article">
  
  <header>
    
      <h1 class="entry-title">Xquery Optimization Tips</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-01T09:39:00-06:00" pubdate data-updated="true">Jul 1<span>st</span>, 2010</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>My first xquery experience has been on the MarkLogic platform.  The project that we just released was written entirely in xquery and on that platform.  As our site continues to gains popularity, we continue to realize how little about xquery we knew or know.  Sometimes and in some places, the site is just really not that performant.  &#8220;But I thought MarkLogic/xquery is super-scalable,&#8221; some exclaim indignantly.  If you do it right, an Oracle relational database can be made to scale.  Done wrong, a MarkLogic database can be made to not scale at all.  There&#8217;s a lot to be said about knowledge of the platform, the language, and how to wrestle it to do your bidding.  Here are a few optimization ditties that I&#8217;ve collected as of late that might help in your future xquery dev.</p>

<!--more-->


<ul>
<li><p>Flatten your query - This means push your where clause into the xpath at the beginning of your FLOWR statement, limiting the amount of work you have to do once you&#8217;re inside the for statement.</p></li>
<li><p>Limit your data set - Do whatever it takes.  You just want to get to the smallest set of data possible in the most direct way.  For us, that has meant putting the most specific predicate first or keeping active datasets in a collection (king of AoP-like, not affecting persisted XML data)</p></li>
<li><p>Query once, reference later - This comes pretty naturally in a, say, Oracle world, because it takes so much work to get down to the persistence layer and retrieve the data.  In xquery, the data sits so much closer to your app layer, giving you plenty of easy access.  Just think of it as taking another needless roundtrip to the database every time you want to run a little xpath action.</p></li>
<li><p>Favor xdmp:estimate() - If you can, use xdmp:estimate() because it&#8217;s faster.  And, it&#8217;s accurate if counting at fragment boundaries (doc roots).</p></li>
<li><p>Beware calculations - &#8220;select count (id)&#8221; might work snappy quick in sql, but do the same thing in xquery, and depending on your xpath or where clause, it&#8217;s gonna work as slow as snot.  The biggest difference?  Probably that documents may need read into memory in their entirety for even a simple result like a count.  Lots of times, it might be good to design for pre-calculations, that happen before the calculation is actually even needed.  For instance, you could put all id&#8217;s for docs in a certain state inside of a single doc, which is much cheaper to query than many.</p></li>
<li><p>Know your indexes - I&#8217;m definitely still learning this one:  which ones are being used implicitly w/o being setup by an admin.  Here&#8217;s a pearl that we just picked up: Range indexes will significantly increase the performance of your order by clauses that use those indexed elements/attributes (including fn:distinct-values()).</p></li>
<li><p>Limit logging - By nature, file i/o can be expensive.  If you want to keep it in, but turn it off, protect it with a conditional (it&#8217;s a lazy calculation and hopefully a cheap one too).</p></li>
<li><p>Beware the double slash - This is a given, even for the xquery newb.  This is tree traversal galore.  Then again, don&#8217;t be afraid to use it, when helpful, for data sets that are always guaranteed to be known and small.</p></li>
<li><p>Utilize search functions - MarkLogic, for instance, has many performance optimizations built into its search capability.  Sometimes it will be more performant to use a search function as opposed to raw xpath.  For example, if an element personId is supplant deep in the bowels of an xml document, requiring xpath muscle to get in, find docs with a particular personId, and return the set, you could do something simple like cts:search(/doc,cts:element-word-query(xs:QName(&#8220;personId&#8221;), $personId)) that could be legions faster.</p></li>
</ul>


<p>Those are some dev tips, here are your tools, really quickly:</p>

<ul>
<li><p>Known and love <a href="http://developer.marklogic.com/code/cq">CQ</a> and its profiler</p></li>
<li><p>xdmp:query-trace() and  xdmp:query-meters()</p></li>
<li><p>Some code to generate large amounts of data for you to test on</p></li>
</ul>


<p>Finally:</p>

<ul>
<li><p>There are a few more tips in the Priscilla Walmsley <a href="http://www.amazon.com/XQuery-Priscilla-Walmsley/dp/0596006349/ref=sr_1_1?ie=UTF8&amp;s=books&amp;qid=1278002233&amp;sr=8-1">XQuery</a> book, chapter 15.</p></li>
<li><p>Performance guide available at <a href="http://developer.marklogic.com/docs">developer.marklogic.org</a>.</p></li>
</ul>


<p>Happy coding.  And remember, it&#8217;s always possible to write bad, unperformant code.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jake Trent</span></span>

      








  


<time datetime="2010-07-01T09:39:00-06:00" pubdate data-updated="true">Jul 1<span>st</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/code/'>Code</a>, <a class='category' href='/blog/categories/marklogic/'>marklogic</a>, <a class='category' href='/blog/categories/performance/'>performance</a>, <a class='category' href='/blog/categories/xquery/'>xquery</a>
  
</span>


    </p>
    
      <div class="sharing"></div>

    
    <p class="meta">
      
        <a class="prev-article-link" href="/post/jquery-plugin-safesubmit/" title="Previous Post: Jquery Plugin: safesubmit">&laquo; Jquery Plugin: safesubmit</a>
      
      
        <a class="next-article-link" href="/post/ideal-tech-conferences/" title="Next Post: Ideal Tech Conferences">Ideal Tech Conferences &raquo;</a>
      
    </p>
  </footer>
</article>

  <section class="comments">
    <h2 class="comments-title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

    </div>
  </div>
  <div class="footer-container">
    <footer class="main-footer" role="contentinfo"><div class="main-footer-logo"></div>
<ul class="main-footer-links-list">
  <li class="main-footer-links-item">
    <span class="main-footer-verbage">Content licensed</span> 2014 <a href="http://creativecommons.org/licenses/by/3.0/us/">CC 3.0 Attribution</a>
  </li>
  <li class="main-footer-links-item">
    <span class="main-footer-verbage">Authored by </span><a href="https://plus.google.com/115032056022257436849?rel=author">Jake Trent</a>
  </li>
  <li class="main-footer-links-item">
    <span class="main-footer-verbage">Subscribe to the </span><a href="/atom.xml">Feed</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <a href="/sitemap.xml">Sitemap</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <a href="https://github.com/jaketrent/jaketrent-blog/issues">Report a Bug</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <span class="main-footer-verbage">Chat on </span><a href="https://keybase.io/jaketrent">Keybase</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <span class="main-footer-verbage">Powered by </span><a href="http://octopress.org">Octopress</a>
  </li>
</ul>
</footer>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'jaketrent';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jaketrent.com/post/xquery-optimization-tips/';
        var disqus_url = 'http://jaketrent.com/post/xquery-optimization-tips/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
