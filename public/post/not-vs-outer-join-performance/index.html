
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Not in vs. Outer join Performance - Jake Trent</title>

  <meta name="author" content="https://plus.google.com/115032056022257436849">
  
  <meta name="description" content="I was running an SQL query today and it was sooooo slow. So slow, in fact, that it never returned. I asked the DBA, Reed, who built the table what &hellip;">
  <meta name="keywords" content="oracle, performance, sql">
  <meta name="copyright" content="http://creativecommons.org/licenses/by/3.0/us/" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Not in vs. Outer join Performance" />
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://jaketrent.com/post/not-vs-outer-join-performance/" />
  <meta property="og:description" content="I was running an SQL query today and it was sooooo slow. So slow, in fact, that it never returned. I asked the DBA, Reed, who built the table what &hellip;" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Not in vs. Outer join Performance" />
  <meta name="twitter:description" content="I was running an SQL query today and it was sooooo slow. So slow, in fact, that it never returned. I asked the DBA, Reed, who built the table what &hellip;" />
  

  
  <link rel="canonical" href="http://jaketrent.com/post/not-vs-outer-join-performance/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Jake Trent" type="application/atom+xml">
  <meta name="google-site-verification" content="uvx7BhaUTNz29nQgydsFPRsErfqYBhPEV_svnHvW7H0" />

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16224416-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="container">
    <div class="sidebar">
      <section class="logo">
  <header class="logo-header">
    <h2 class="logo-title">
      <a class="logo-link" href="/">
        <span class="logo-img"></span>
      </a>
    </h2>
  </header>
</section>

      <nav class="main-nav" role="navigation"><ul class="main-nav-list">
  <li class="main-nav-item">
    <a class="main-nav-link" href="/">Blog</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="/work">Work</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="https://books.jaketrent.com">Books</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="https://github.com/jaketrent">Github</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="http://www.linkedin.com/in/jaketrent">LinkedIn</a>
  </li>
</ul>
</nav>
    </div>
    <div class="content">
      <div>
<article class="entry entry-detail" role="article">
  
  <header>
    
      <h1 class="entry-title">Not in vs. Outer Join Performance</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-17T12:59:00-06:00" pubdate data-updated="true">Sep 17<span>th</span>, 2009</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>I was running an SQL query today and it was sooooo slow.  So slow, in fact, that it never returned.  I asked the DBA, Reed, who built the table what might be up, and he informed me that it was not indexed.  And proceeded to show me some cool stuff I could do to actually get my query to return.  In the end, it was a comparison between the &#8220;not in&#8221; operator and a &#8220;left join&#8221;.</p>

<!--more-->


<p>My original query was thus, names changed to protect the innocent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'><span class="k">from</span>   <span class="n">temp_legacy_attachments</span> <span class="n">i</span>
</span><span class='line'><span class="k">where</span>  <span class="n">i</span><span class="p">.</span><span class="n">person_id</span> <span class="k">not</span> <span class="k">in</span> <span class="p">(</span>
</span><span class='line'>  <span class="k">select</span> <span class="n">m</span><span class="p">.</span><span class="n">legacy_person_id</span>
</span><span class='line'>  <span class="k">from</span>   <span class="n">new_attachment</span> <span class="n">a</span>
</span><span class='line'>  <span class="p">,</span>      <span class="n">person</span> <span class="n">p</span>
</span><span class='line'>  <span class="k">where</span>  <span class="n">a</span><span class="p">.</span><span class="n">person_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>I was trying to query the temp_legacy_attachments to get all rows that didn&#8217;t have a record in the new_attachments table.  It never returned, and so Reed told me to give this one a try:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
</span><span class='line'><span class="k">from</span>   <span class="n">temp_legacy_attachments</span> <span class="n">i</span>
</span><span class='line'><span class="k">left</span> <span class="k">join</span> <span class="p">(</span>
</span><span class='line'>  <span class="k">select</span> <span class="n">m</span><span class="p">.</span><span class="n">legacy_person_id</span>
</span><span class='line'>  <span class="k">from</span>   <span class="n">new_attachment</span> <span class="n">a</span>
</span><span class='line'>  <span class="p">,</span>      <span class="n">person</span> <span class="n">p</span>
</span><span class='line'>  <span class="k">where</span>  <span class="n">a</span><span class="p">.</span><span class="n">person_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="n">ea</span> <span class="k">on</span> <span class="n">ea</span><span class="p">.</span><span class="n">legacy_person_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">person_id</span>
</span><span class='line'><span class="k">where</span> <span class="n">ea</span><span class="p">.</span><span class="n">legacy_person_id</span> <span class="k">is</span> <span class="k">null</span> <span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, instead of using &#8220;not in&#8221; a set, I select all the legacy rows, then outer join to the new_attachment rows and filter where a column on the new attachment set is null (it&#8217;s the smaller/less-available set).</p>

<p>I thought it was pretty sweet.  No magic bullet, though, as Reed tells me that there is a fair amount of debate over the performance difference between the two methods.  You just have to try it and find out.  For me, in this case, the outer join was more awesome.</p>

<h3>Update</h3>

<p>Another savvy DBA, Bill, has graced us with another method yet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="k">sum</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
</span><span class='line'><span class="k">from</span> <span class="p">(</span>
</span><span class='line'>  <span class="k">select</span> <span class="n">p</span><span class="p">.</span><span class="n">legacy_person_id</span>
</span><span class='line'>  <span class="p">,</span>      <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">cnt</span>
</span><span class='line'>  <span class="k">from</span>   <span class="n">person</span> <span class="n">p</span>
</span><span class='line'>  <span class="k">join</span>   <span class="n">temp_legacy_attachments</span> <span class="n">i</span> <span class="k">on</span> <span class="n">i</span><span class="p">.</span><span class="n">person_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">legacy_person_id</span>
</span><span class='line'>  <span class="k">where</span>  <span class="k">not</span> <span class="k">exists</span>
</span><span class='line'>    <span class="p">(</span><span class="k">select</span> <span class="k">null</span>
</span><span class='line'>    <span class="k">from</span>   <span class="n">new_attachments</span> <span class="n">a</span>
</span><span class='line'>    <span class="k">where</span>  <span class="n">a</span><span class="p">.</span><span class="n">person_id</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'>    <span class="k">and</span>    <span class="n">a</span><span class="p">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="s1">&#39;LEGACY_MIGRATION&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">group</span> <span class="k">by</span> <span class="n">p</span><span class="p">.</span><span class="n">legacy_person_id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jake Trent</span></span>

      








  


<time datetime="2009-09-17T12:59:00-06:00" pubdate data-updated="true">Sep 17<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/code/'>Code</a>, <a class='category' href='/blog/categories/oracle/'>oracle</a>, <a class='category' href='/blog/categories/performance/'>performance</a>, <a class='category' href='/blog/categories/sql/'>sql</a>
  
</span>


    </p>
    
      <div class="sharing"></div>

    
    <p class="meta">
      
        <a class="prev-article-link" href="/post/installcert-java-security-certificate/" title="Previous Post: InstallCert for Java Security Certificate">&laquo; InstallCert for Java Security Certificate</a>
      
      
        <a class="next-article-link" href="/post/mount-samba-fs-linux/" title="Next Post: Mount Samba FS on Linux">Mount Samba FS on Linux &raquo;</a>
      
    </p>
  </footer>
</article>

  <section class="comments">
    <h2 class="comments-title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

    </div>
  </div>
  <div class="footer-container">
    <footer class="main-footer" role="contentinfo"><div class="main-footer-logo"></div>
<ul class="main-footer-links-list">
  <li class="main-footer-links-item">
    <span class="main-footer-verbage">Content licensed</span> 2014 <a href="http://creativecommons.org/licenses/by/3.0/us/">CC 3.0 Attribution</a>
  </li>
  <li class="main-footer-links-item">
    <span class="main-footer-verbage">Authored by </span><a href="https://plus.google.com/115032056022257436849?rel=author">Jake Trent</a>
  </li>
  <li class="main-footer-links-item">
    <span class="main-footer-verbage">Subscribe to the </span><a href="/atom.xml">Feed</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <a href="/sitemap.xml">Sitemap</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <a href="https://github.com/jaketrent/jaketrent-blog/issues">Report a Bug</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <span class="main-footer-verbage">Chat on </span><a href="https://keybase.io/jaketrent">Keybase</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <span class="main-footer-verbage">Powered by </span><a href="http://octopress.org">Octopress</a>
  </li>
</ul>
</footer>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'jaketrent';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jaketrent.com/post/not-vs-outer-join-performance/';
        var disqus_url = 'http://jaketrent.com/post/not-vs-outer-join-performance/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
