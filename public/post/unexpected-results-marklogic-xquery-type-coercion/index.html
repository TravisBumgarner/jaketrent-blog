
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Unexpected Results in MarkLogic Xquery Type Coercion - Jake Trent</title>

  <meta name="author" content="https://plus.google.com/115032056022257436849">
  
  <meta name="description" content="Recently, we've been working on writing an API using xquery. We have wanted to make the API as solid as possible, since we're putting the brunt of &hellip;">
  <meta name="keywords" content="marklogic, typing, xquery">
  <meta name="copyright" content="http://creativecommons.org/licenses/by/3.0/us/" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Unexpected Results in MarkLogic Xquery Type Coercion" />
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://jaketrent.com/post/unexpected-results-marklogic-xquery-type-coercion/" />
  <meta property="og:description" content="Recently, we've been working on writing an API using xquery. We have wanted to make the API as solid as possible, since we're putting the brunt of &hellip;" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Unexpected Results in MarkLogic Xquery Type Coercion" />
  <meta name="twitter:description" content="Recently, we've been working on writing an API using xquery. We have wanted to make the API as solid as possible, since we're putting the brunt of &hellip;" />
  

  
  <link rel="canonical" href="http://jaketrent.com/post/unexpected-results-marklogic-xquery-type-coercion/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Jake Trent" type="application/atom+xml">
  <meta name="google-site-verification" content="uvx7BhaUTNz29nQgydsFPRsErfqYBhPEV_svnHvW7H0" />

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16224416-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="container">
    <div class="sidebar">
      <section class="logo">
  <header class="logo-header">
    <h2 class="logo-title">
      <a class="logo-link" href="/">
        <span class="logo-img"></span>
      </a>
    </h2>
  </header>
</section>

      <nav class="main-nav" role="navigation"><ul class="main-nav-list">
  <li class="main-nav-item">
    <a class="main-nav-link" href="/">Blog</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="/work">Work</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="https://books.jaketrent.com">Books</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="https://github.com/jaketrent">Github</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="http://www.linkedin.com/in/jaketrent">LinkedIn</a>
  </li>
</ul>
</nav>
    </div>
    <div class="content">
      <div>
<article class="entry entry-detail" role="article">
  
  <header>
    
      <h1 class="entry-title">Unexpected Results in MarkLogic Xquery Type Coercion</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-17T07:02:00-07:00" pubdate data-updated="true">Dec 17<span>th</span>, 2010</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Recently, we&#8217;ve been working on writing an API using xquery.  We have wanted to make the API as solid as possible, since we&#8217;re putting the brunt of the complexity of our system into this module of code.  What might typing our parameters and return types give us?  We are hoping for safety and readability.</p>

<!--more-->


<p>Safety-wise, we&#8217;re a little perplexed on how safe typing really is.  In the past, it&#8217;s helped fail fast, providing feedback on data anomalies or bad conditions during test.  But, if you haven&#8217;t tested a particular condition that would trigger an error, you&#8217;re going to have to wait until runtime to then get the app to blow up in your face.  A compile-time check would be really nice here.</p>

<p>Readability, I think, is vastly improved by typing parameters and return types.  I&#8217;m very thankful that the built-in functions of MarkLogic, the Xquery implementation I use most often, are so annotated.  I also dig the occurrence indicators a la regex that provide terse, elegant meaning.</p>

<p>In trying to get to the point of increased safety and readability, I&#8217;ve also reached the point of increased confusion.  We setup an example of what we thought would error out, but instead it still didn&#8217;t work, but gave us something unexpected.  Here&#8217;s the example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>xquery version "1.0-ml";
</span><span class='line'>
</span><span class='line'>declare namespace aw = "awesome";
</span><span class='line'>
</span><span class='line'>declare function aw:foo($in as xs:string) as xs:string? {
</span><span class='line'>  ()
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>declare function aw:foo2($in as xs:string) {
</span><span class='line'>  "sweetness"
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>aw:foo2(aw:foo("something"))</span></code></pre></td></tr></table></div></figure>


<p>The function foo2() is supposed to requires a string and return &#8220;sweetness&#8221;.  We pass into foo2() the result of foo(), which is always an empty sequence, so we would have expected the call to foo2() to blow some serious xml chunks.  Instead, the return value of the whole expression is also empty sequence.  Will someone please explain why this is, because foo2() is hardcoded to return &#8220;sweetness&#8221;.  Is it that foo2() is never called?  And if so, why does that seem to happen silently?  Doesn&#8217;t that seem dangerous?  The mysteries mount.</p>

<p>If I change the xquery version itself on this code to read:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>xquery version "1.0";</span></code></pre></td></tr></table></div></figure>


<p>Now we&#8217;re back into vanilla Xquery land without the MarkLogic flavor.  Now, I get what seems to be a more expected response.  Calling this code now yields this lovely:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1.0] XDMP-AS: (err:XPTY0004) $in as xs:string -- Invalid coercion: () as xs:string
</span><span class='line'>Stack trace:
</span><span class='line'>
</span><span class='line'>line 9:
</span><span class='line'>7: };
</span><span class='line'>8: 
</span><span class='line'>9: declare function aw:foo2($in as xs:string) {
</span><span class='line'>10: "sweetness"
</span><span class='line'>11: };
</span><span class='line'>
</span><span class='line'>aw:foo2(())
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>line 13:
</span><span class='line'>11: };
</span><span class='line'>12: 
</span><span class='line'>13: aw:foo2(aw:foo("something"))
</span><span class='line'>14: 
</span><span class='line'>15:</span></code></pre></td></tr></table></div></figure>


<p>So, is this a bug in the MarkLogic implementation of type checking, coercion or something else?  Beats me, but for now this is something that makes me a little more unsure of the code I write in Xquery/MarkLogic.  Help me Obi-wan, you&#8217;re my only hope.</p>

<p><strong>Update - Mystery Solved</strong></p>

<p>Kelly Stirman of MarkLogic was kind enough to comment on my consternation (see his post below).  I took his advice, saw the coercion error that I was observing when running in vanilla 1.0 xquery, and the universe came back into alignment.</p>

<p>So, it turns out that my function foo2() was indeed never called.  From the <a href="http://docs.marklogic.com/4.2doc/docapp.xqy#display.xqy?fname=http://pubs/4.2doc/xml/xquery/enhanced.xml%2355459">MarkLogic Docs</a> describing function mapping:</p>

<p>One consequence of function mapping, which can be <strong>surprising</strong> the first time you see it, is that if the value passed for a parameter is the empty sequence, it could result in the function being called 0 times (that is, in the function never runs and results in the empty sequence. For example, if you entered the empty sequence as the parameter to the above function call, it returns empty, as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>xquery version "1.0-ml";
</span><span class='line'>
</span><span class='line'>declare function local:print-word ($word as xs:string) { $word };
</span><span class='line'>
</span><span class='line'>local:print-word( () )
</span><span class='line'>(: 
</span><span class='line'>   evaluates the print-word function zero times, resulting 
</span><span class='line'>   in the empty sequence
</span><span class='line'>:)</span></code></pre></td></tr></table></div></figure>


<p>The <code>local:print-word</code> function is never called in this case, because it is iterating over the empty sequence, which causes zero invocations of the function. If your function calls are fed by code that can return the empty sequence (an XPath expression, for example), then you might see this behavior.</p>

<p>And boy was I surprised. :)</p>

<p>So, what was the fix?  It was to disable function mapping that MarkLogic-flavored Xquery adds as an extension to the language:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>xquery version "1.0-ml";
</span><span class='line'>
</span><span class='line'>declare namespace aw = "awesome";
</span><span class='line'>
</span><span class='line'>declare namespace xdmp = "http://marklogic.com/xdmp";
</span><span class='line'>
</span><span class='line'>declare option xdmp:mapping "false"; 
</span><span class='line'>
</span><span class='line'>declare function aw:foo($in as xs:string) as xs:string? {
</span><span class='line'>  ()
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>declare function aw:foo2($in as xs:string) {
</span><span class='line'>  "else"
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>aw:foo2(aw:foo("something"))</span></code></pre></td></tr></table></div></figure>


<p>This yielded:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[1.0-ml] XDMP-AS: (err:XPTY0004) $in as xs:string -- Invalid coercion: () as xs:string</span></code></pre></td></tr></table></div></figure>


<p>And I felt much better knowing what was happening in the code.</p>

<p>The behavior of not calling a function when passed an empty sequence when function mapping is on does not seem very intuitive to me, but it does seem to fit in with the logic of function mapping if it treats for the sequence as the variable iterated on in the for a FLWOR.  Recently, I&#8217;ve created a hotkey for turning off function mapping for other reasons, and now here&#8217;s another one.  I have obviously not leveled up sufficiently to handle this function mapping beast with any dexterity.</p>

<p>Thanks, Kelly, for letting our souls rest easier over the holidays. :)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jake Trent</span></span>

      








  


<time datetime="2010-12-17T07:02:00-07:00" pubdate data-updated="true">Dec 17<span>th</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/code/'>Code</a>, <a class='category' href='/blog/categories/marklogic/'>marklogic</a>, <a class='category' href='/blog/categories/typing/'>typing</a>, <a class='category' href='/blog/categories/xquery/'>xquery</a>
  
</span>


    </p>
    
      <div class="sharing"></div>

    
    <p class="meta">
      
        <a class="prev-article-link" href="/post/growing-a-whole-new-mind/" title="Previous Post: Growing a Whole New Mind">&laquo; Growing a Whole New Mind</a>
      
      
        <a class="next-article-link" href="/post/xsd-validation-marklogic/" title="Next Post: XSD Validation in MarkLogic">XSD Validation in MarkLogic &raquo;</a>
      
    </p>
  </footer>
</article>

  <section class="comments">
    <h2 class="comments-title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

    </div>
  </div>
  <div class="footer-container">
    <footer class="main-footer" role="contentinfo"><div class="main-footer-logo"></div>
<ul class="main-footer-links-list">
  <li class="main-footer-links-item">
    <span class="main-footer-verbage">Content licensed</span> 2014 <a href="http://creativecommons.org/licenses/by/3.0/us/">CC 3.0 Attribution</a>
  </li>
  <li class="main-footer-links-item">
    <span class="main-footer-verbage">Authored by </span><a href="https://plus.google.com/115032056022257436849?rel=author">Jake Trent</a>
  </li>
  <li class="main-footer-links-item">
    <span class="main-footer-verbage">Subscribe to the </span><a href="/atom.xml">Feed</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <a href="/sitemap.xml">Sitemap</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <a href="https://github.com/jaketrent/jaketrent-blog/issues">Report a Bug</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <span class="main-footer-verbage">Chat on </span><a href="https://keybase.io/jaketrent">Keybase</a>
  </li>
  <li class="main-footer-links-item main-footer-links-item-extra">
    <span class="main-footer-verbage">Powered by </span><a href="http://octopress.org">Octopress</a>
  </li>
</ul>
</footer>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'jaketrent';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jaketrent.com/post/unexpected-results-marklogic-xquery-type-coercion/';
        var disqus_url = 'http://jaketrent.com/post/unexpected-results-marklogic-xquery-type-coercion/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
