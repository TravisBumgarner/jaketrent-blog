
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>XQuery Dynamic Order By - Jake Trent</title>

  <meta name="author" content="https://plus.google.com/115032056022257436849">
  
  <meta name="description" content="When ordering a sequence of items in XQuery, sometimes it's desirable to be able to decide the order based on a parameter value (something dynamic). &hellip;">
  <meta name="keywords" content="marklogic, xquery">
  <meta name="copyright" content="http://creativecommons.org/licenses/by/3.0/us/" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="XQuery Dynamic Order By" />
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://jaketrent.com/post/xquery-dynamic-order/" />
  <meta property="og:description" content="When ordering a sequence of items in XQuery, sometimes it's desirable to be able to decide the order based on a parameter value (something dynamic). &hellip;" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="XQuery Dynamic Order By" />
  <meta name="twitter:description" content="When ordering a sequence of items in XQuery, sometimes it's desirable to be able to decide the order based on a parameter value (something dynamic). &hellip;" />
  

  
  <link rel="canonical" href="http://jaketrent.com/post/xquery-dynamic-order/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Jake Trent" type="application/atom+xml">
  <meta name="google-site-verification" content="uvx7BhaUTNz29nQgydsFPRsErfqYBhPEV_svnHvW7H0" />

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16224416-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="container">
    <div class="sidebar">
      <section class="logo">
  <header class="logo-header">
    <h2 class="logo-title">
      <a class="logo-link" href="/">
        <span class="logo-img"></span>
      </a>
    </h2>
  </header>
</section>

      <nav class="main-nav" role="navigation"><ul class="main-nav-list">
  <li class="main-nav-item">
    <a class="main-nav-link" href="/">Blog</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="/work">Work</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="/books">Books</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="https://github.com/jaketrent">Github</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="http://www.linkedin.com/in/jaketrent">LinkedIn</a>
  </li>
</ul>
</nav>
    </div>
    <div class="content">
      <div>
<article class="entry entry-detail" role="article">
  
  <header>
    
      <h1 class="entry-title">XQuery Dynamic Order By</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-19T11:45:00-06:00" pubdate data-updated="true">May 19<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>When ordering a sequence of items in XQuery, sometimes it&#8217;s desirable to be able to decide the order based on a parameter value (something dynamic).  XQuery doesn&#8217;t look extremely elegant when it comes to this feature, but depending on exactly what you want, you should be able to get the job done.</p>

<!--more-->


<h2>Static sort</h2>

<p>In XQuery, an a FLWOR statement can be ordered (the &#8220;O&#8221; in FLWOR).  Here are some taffy f</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let $items := 
</span><span class='line'>  &lt;taffies&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;13&lt;/quantity&gt;&lt;flavor&gt;Root Beer&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;5&lt;/quantity&gt;&lt;flavor&gt;Black Licorice&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;133&lt;/quantity&gt;&lt;flavor&gt;Cotton Candy&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>  &lt;/taffies&gt;
</span><span class='line'>for $i in $items/taffy
</span><span class='line'>order by xs:integer($i/quantity)
</span><span class='line'>return $i</span></code></pre></td></tr></table></div></figure>


<p>Note that if you want to sort by something besides the natural order of string values (in this case, an <code>xs:integer</code>), you need to cast the value.</p>

<h2>Dynamic ascending or descending</h2>

<p>Ascending order means lowest values will be listed first, and the higher values will be listed later.  Descending means just the opposite.  By default, XQuery order by clauses are sorted in ascending order.</p>

<p>Let&#8217;s say that you have just <em>one</em> sort commparator (in this case, quantity) that you care to sort by.  But there&#8217;s some toggle in your logic or UI or somewhere that determines whether things should be sorted in ascending or descending order.  A <a href="http://markmail.org/thread/rpc3unlqlj72loah#query:+page:1+mid:k3zprjr4civlrkfg+state:results">nice markmail thread from Michael Blakely</a> reveals a nice solution.  For our example, it would look something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let $ascending := fn:false()
</span><span class='line'>let $items := 
</span><span class='line'>  &lt;taffies&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;13&lt;/quantity&gt;&lt;flavor&gt;Root Beer&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;5&lt;/quantity&gt;&lt;flavor&gt;Black Licorice&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;133&lt;/quantity&gt;&lt;flavor&gt;Cotton Candy&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>  &lt;/taffies&gt;
</span><span class='line'>for $i in $items/taffy
</span><span class='line'>order by
</span><span class='line'>  if ($ascending) then xs:integer($i/quantity) else () ascending,
</span><span class='line'>  if ($ascending) then () else xs:integer($i/quantity) descending
</span><span class='line'>return $i</span></code></pre></td></tr></table></div></figure>


<p>The syntax is a little odd in order for us to get the result we want.  There are two <code>if</code> expressions.  They are separated by commas, so it is pretty much just a primary, then secondary sort.  The conditional is the same on each (&#8220;if is ascending&#8221;);  But then notice that was just a way to get the syntax to work, because it&#8217;s really an if-else.</p>

<h2>Multiple Sort Values</h2>

<p>The next case is slightly more complicated, but I initially tried the Michael Blakely approach.  This case introduced another parameter:  Sometimes I wanted to sort by quantity, but other times I instead wanted to sort by the name of the flavor.  So, I came out with something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let $ascending := fn:false()
</span><span class='line'>let $sortby := "flavor"
</span><span class='line'>let $items := 
</span><span class='line'>  &lt;taffies&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;13&lt;/quantity&gt;&lt;flavor&gt;Root Beer&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;5&lt;/quantity&gt;&lt;flavor&gt;Black Licorice&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;133&lt;/quantity&gt;&lt;flavor&gt;Cotton Candy&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>  &lt;/taffies&gt;
</span><span class='line'>for $i in $items/taffy
</span><span class='line'>order by
</span><span class='line'>  if ($ascending and $sortby eq "quantity") then xs:integer($i/quantity) else () ascending,
</span><span class='line'>  if ($ascending and $sortby eq "quantity") then () else xs:integer($i/quantity) descending
</span><span class='line'>  if ($ascending and $sortby eq "flavor") then $i/flavor else () ascending,
</span><span class='line'>  if ($ascending and $sortby eq "flavor") then () else $i/flavor descending
</span><span class='line'>return $i</span></code></pre></td></tr></table></div></figure>


<p>El problemo is that because these are essentially just a list of secondary sorts and each <code>if</code> conditional has an <code>else</code> with an actual sort value, I&#8217;m not really sorting by just one thing.  This scenario has <code>$sortby</code> set to &#8220;flavor&#8221;, but it&#8217;s really still sorting by quantity descending primarily, then flavor descending secondarily.  Blast.</p>

<h2>Fully-dynamic order by clause &#8211; and everything else</h2>

<p>At this point, I was contemplating doing the full smash and just evaluating a dynamically-built string describing my desired query:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let $ascending := fn:false()
</span><span class='line'>let $sortby := "flavor"
</span><span class='line'>let $items := 
</span><span class='line'>  &lt;taffies&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;13&lt;/quantity&gt;&lt;flavor&gt;Root Beer&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;5&lt;/quantity&gt;&lt;flavor&gt;Black Licorice&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;133&lt;/quantity&gt;&lt;flavor&gt;Cotton Candy&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>  &lt;/taffies&gt;
</span><span class='line'>return xdmp:value(fn:concat("for $i in $items/taffy ",
</span><span class='line'>"order by $i/", $sortby, 
</span><span class='line'>if ($ascending) then
</span><span class='line'>  " ascending "
</span><span class='line'>else
</span><span class='line'>  " descending ",
</span><span class='line'>"return $i"))</span></code></pre></td></tr></table></div></figure>


<p>I guess that&#8217;s all right.  I try to avoid string->query conversions just for safety and code complexity, but perhaps I call <code>xdmp:value</code> safe enough here, since it&#8217;s just executing XQuery within the context of the current expression, because I could call this <em>less</em> complex than the previous (albeit not what we want) scenario.</p>

<p>So, what did I end up with?</p>

<h2>Sort by dynamic value first</h2>

<p>Again, all I wanted to was to sort by a single value based on a parameter, and have ascending/descending be another variable parameter.  If you don&#8217;t care to get a descending sort, then dynamic order by is actually not too bad.  So, get that out of the way and then decide if you like the order or not.  If not, it must be backward, so reverse it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>let $ascending := fn:false()
</span><span class='line'>let $sortby := "flavor"
</span><span class='line'>let $items := 
</span><span class='line'>  &lt;taffies&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;13&lt;/quantity&gt;&lt;flavor&gt;Root Beer&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;5&lt;/quantity&gt;&lt;flavor&gt;Black Licorice&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>    &lt;taffy&gt;&lt;quantity&gt;133&lt;/quantity&gt;&lt;flavor&gt;Cotton Candy&lt;/flavor&gt;&lt;/taffy&gt;
</span><span class='line'>  &lt;/taffies&gt;
</span><span class='line'>let $sorted := 
</span><span class='line'>  for $i in $items/taffy
</span><span class='line'>  order by
</span><span class='line'>    if ($sortby eq "quantity") then 
</span><span class='line'>      xs:integer($i/quantity)
</span><span class='line'>    else if ($sortby eq "flavor") then 
</span><span class='line'>      $i/flavor
</span><span class='line'>    else 
</span><span class='line'>      ()
</span><span class='line'>  return $i
</span><span class='line'>return if ($ascending) then
</span><span class='line'>  $sorted
</span><span class='line'>else
</span><span class='line'>  fn:reverse($sorted)</span></code></pre></td></tr></table></div></figure>


<p>Thanks for the suggestion, Tommy.  It&#8217;s simple.  Maybe not super-efficient for large datasets.  But, it gets the job done.</p>

<p>Any other awesome ways you&#8217;ve found to get dynamic order by clauses in your XQuery statements?</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jake Trent</span></span>

      








  


<time datetime="2012-05-19T11:45:00-06:00" pubdate data-updated="true">May 19<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/code/'>Code</a>, <a class='category' href='/blog/categories/marklogic/'>marklogic</a>, <a class='category' href='/blog/categories/xquery/'>xquery</a>
  
</span>


    </p>
    
      <div class="sharing"></div>

    
    <p class="meta">
      
        <a class="prev-article-link" href="/post/intro-backbonejs/" title="Previous Post: Intro to BackboneJs">&laquo; Intro to BackboneJs</a>
      
      
        <a class="next-article-link" href="/post/handlebars-loop-index/" title="Next Post: Handlebars For-Loop Index">Handlebars For-Loop Index &raquo;</a>
      
    </p>
  </footer>
</article>

  <section class="comments">
    <h2 class="comments-title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

    </div>
  </div>
  <div class="container">
    <footer class="main-footer" role="contentinfo"><p>
  <a href="http://creativecommons.org/licenses/by/3.0/us/">CC 3.0 Attribution</a> 2014 -
  <a href="https://plus.google.com/115032056022257436849?rel=author">Jake Trent</a> -
  <a href="/atom.xml">Feed</a>
  <span class="main-footer-extras">-
    <a href="/sitemap.xml">Sitemap</a> -
    <a href="https://github.com/jaketrent/jaketrent-blog/issues">Report a Bug</a> -
    <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  </span>
</p>

</footer>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'jaketrent';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jaketrent.com/post/xquery-dynamic-order/';
        var disqus_url = 'http://jaketrent.com/post/xquery-dynamic-order/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
