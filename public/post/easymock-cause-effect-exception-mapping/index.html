
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>EasyMock Cause-Effect Exception Mapping - Jake Trent</title>

  <meta name="author" content="https://plus.google.com/115032056022257436849">
  
  <meta name="description" content="EasyMock is a great tool for separating external dependencies from unit tests. There is a learning curve to learning the mock method of testing, and &hellip;">
  <meta name="keywords" content="easymock, java, unit-testing">
  <meta name="copyright" content="http://creativecommons.org/licenses/by/3.0/us/" />

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="EasyMock Cause-Effect Exception Mapping" />
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://jaketrent.com/post/easymock-cause-effect-exception-mapping/" />
  <meta property="og:description" content="EasyMock is a great tool for separating external dependencies from unit tests. There is a learning curve to learning the mock method of testing, and &hellip;" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="EasyMock Cause-Effect Exception Mapping" />
  <meta name="twitter:description" content="EasyMock is a great tool for separating external dependencies from unit tests. There is a learning curve to learning the mock method of testing, and &hellip;" />
  

  
  <link rel="canonical" href="http://jaketrent.com/post/easymock-cause-effect-exception-mapping/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Jake Trent" type="application/atom+xml">
  <meta name="google-site-verification" content="uvx7BhaUTNz29nQgydsFPRsErfqYBhPEV_svnHvW7H0" />

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16224416-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="container">
    <div class="sidebar">
      <section class="logo">
  <header class="logo-header">
    <h2 class="logo-title">
      <a class="logo-link" href="/">
        <span class="logo-img"></span>
      </a>
    </h2>
  </header>
</section>

      <nav class="main-nav" role="navigation"><ul class="main-nav-list">
  <li class="main-nav-item">
    <a class="main-nav-link" href="/">Blog</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="/work">Work</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="/books">Books</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="https://github.com/jaketrent">Github</a>
  </li>
  <li class="main-nav-item">
    <a class="main-nav-link" href="http://www.linkedin.com/in/jaketrent">LinkedIn</a>
  </li>
</ul>
</nav>
    </div>
    <div class="content">
      <div>
<article class="entry entry-detail" role="article">
  
  <header>
    
      <h1 class="entry-title">EasyMock Cause-Effect Exception Mapping</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-07-06T09:36:00-06:00" pubdate data-updated="true">Jul 6<span>th</span>, 2009</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>EasyMock is a great tool for separating external dependencies from unit tests.  There is a learning curve to learning the mock method of testing, and unfortunately, EasyMock does not give very good prompts when you do something wrong.  The exception messages are actually quite cryptic.  This article is meant to be a crude mapping of exception output and the behavior that might have caused it.  At least, this is a log of many of my experiences with EasyMock and how I usually get into the messes I do.  It is quite possible that the same exception output could be had via different behavior.  It&#8217;s also important to note that I&#8217;m not trying to show how to create meaningful tests here (I don&#8217;t even show full tests half the time), only help figure out how mysterious EasyMock exceptions were thrown.  These experiences were documented on EasyMock 2.2 and 2.4.</p>

<!--more-->


<h3>Argument Matcher</h3>

<h4>Exception</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalStateException</span><span class="o">:</span> <span class="mi">2</span> <span class="n">matchers</span> <span class="n">expected</span><span class="o">,</span> <span class="mi">1</span> <span class="n">recorded</span><span class="o">.</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ExpectedInvocation</span><span class="o">.</span><span class="na">createMissingMatchers</span><span class="o">(</span><span class="n">ExpectedInvocation</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">41</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ExpectedInvocation</span><span class="o">.(</span><span class="n">ExpectedInvocation</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">33</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ExpectedInvocation</span><span class="o">.(</span><span class="n">ExpectedInvocation</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">26</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">RecordState</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">RecordState</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">64</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">MockInvocationHandler</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">MockInvocationHandler</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">24</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ObjectMethodsFilter</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">ObjectMethodsFilter</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">45</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">$Proxy0</span><span class="o">.</span><span class="na">findFoos</span><span class="o">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">sun</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">NativeMethodAccessorImpl</span><span class="o">.</span><span class="na">invoke0</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Behavior</h4>

<p>Sometimes you don&#8217;t know the exact instance of the objects that will be passed as arguments into methods on external dependencies.  Thus, the mocked call on that method will be different than normal.  EasyMock provides a method, EasyMock.isA().  From the JavaDoc, this method &#8220;Expects an object implementing the given class.&#8221;  Essentially, it looks for type (class) instead of instance (object) when setting up the EasyMock.expect().  This is useful when you don&#8217;t have the actual instance of a method parameter from the context of your test, like a local variable.</p>

<p>So, if I was testing a method like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeingTested</span> <span class="o">{</span>
</span><span class='line'>   <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">(</span><span class="n">Integer</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">()</span>
</span><span class='line'>      <span class="n">externalService</span><span class="o">.</span><span class="na">serviceCall</span><span class="o">(</span><span class="n">sb</span><span class="o">,</span> <span class="n">code</span><span class="o">);</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">interface</span> <span class="nc">ExternalService</span> <span class="o">{</span>
</span><span class='line'>   <span class="kt">void</span> <span class="nf">serviceCall</span><span class="o">(</span><span class="n">StringBuilder</span> <span class="n">sb</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">code</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And tried to test it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDoSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'>   <span class="n">externalService</span><span class="o">.</span><span class="na">serviceCall</span><span class="o">(</span><span class="n">isA</span><span class="o">(</span><span class="n">StringBuilder</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="mi">123</span><span class="o">);</span>
</span><span class='line'>   <span class="n">expectLastCall</span><span class="o">();</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'>   <span class="n">tested</span><span class="o">.</span><span class="na">doSomething</span><span class="o">(</span><span class="mi">123</span><span class="o">);</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I will inevitably get the above exception.</p>

<h4>Explanation</h4>

<p>So, now to get rid of this nasty exception.  Use of isA() either implies that you really don&#8217;t care what the exact instance of the method parameter is or you use it to get around another constraint on your code.  Either way, EasyMock, through this wonderful exception, is trying to tell you that <strong>if you&#8217;re going to use isA() for one of the method parameters, it must be used on all!</strong>  Thus, to keep your StringBuilder isA() call, you must add one for Integer in this example.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">externalService</span><span class="o">.</span><span class="na">serviceCall</span><span class="o">(</span><span class="n">isA</span><span class="o">(</span><span class="n">StringBuilder</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">isA</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Behavior Definition</h3>

<h4>Exception</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalStateException</span><span class="o">:</span> <span class="n">missing</span> <span class="n">behavior</span> <span class="n">definition</span> <span class="k">for</span> <span class="n">the</span> <span class="n">preceeding</span> <span class="n">method</span> <span class="n">call</span> <span class="n">getIsInitialized</span><span class="o">()</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">MockInvocationHandler</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">MockInvocationHandler</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">30</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ObjectMethodsFilter</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">ObjectMethodsFilter</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">61</span><span class="o">)</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Behavior</h4>

<p>If I was testing a method like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomethingElse</span> <span class="o">{</span>
</span><span class='line'>   <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">externalService</span><span class="o">.</span><span class="na">checkSomething</span><span class="o">();</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">interface</span> <span class="nc">ExternalService</span> <span class="o">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="nf">checkSomething</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And tried to test it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDoSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'>   <span class="n">expect</span><span class="o">(</span><span class="n">externalService</span><span class="o">.</span><span class="na">checkSomething</span><span class="o">());</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'>   <span class="n">tested</span><span class="o">.</span><span class="na">doSomething</span><span class="o">();</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I just may get the above exception.</p>

<h4>Explanation</h4>

<p>The issue is that you&#8217;ve only half-told EasyMock what you expect to happen.  Because the checkSomething() method has a return type other than void, when need to explicitly tell EasyMock what to expect as the return value.  That is done by using the andReturn() method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">expect</span><span class="o">(</span><span class="n">externalService</span><span class="o">.</span><span class="na">checkSomething</span><span class="o">()).</span><span class="na">andReturn</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Mock methods use Mocks</h3>

<h4>Exception</h4>

<p>Here&#8217;s an exception that may very well be thrown in many instances by EasyMock.  It might not be very helpful there; it certainly wasn&#8217;t here.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">RuntimeExceptionWrapper</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">classextension</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">ClassExtensionHelper</span><span class="o">.</span><span class="na">getControl</span><span class="o">(</span><span class="n">ClassExtensionHelper</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">52</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">classextension</span><span class="o">.</span><span class="na">EasyMock</span><span class="o">.</span><span class="na">replay</span><span class="o">(</span><span class="n">EasyMock</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">117</span><span class="o">)</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Behavior</h3>

<p>When you&#8217;re using EasyMock, there are several steps that you need to take in setting up your mock scenario.  And we all know that the more steps a process takes, the more prone it is to error.  Well, as the user of the EasyMock API, I make errors all the time.  For instance, as I&#8217;m evolving my test, deciding that some objects will be mocked one moment and not mocked the next, the test changes but sometimes I forget to adjust the multi-step EasyMock setup process at every step.  For instance, I had a test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Something</span> <span class="n">something</span> <span class="o">=</span> <span class="n">createMock</span><span class="o">(</span><span class="n">Something</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>   <span class="n">Else</span> <span class="k">else</span> <span class="o">=</span> <span class="n">createMock</span><span class="o">(</span><span class="n">Else</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>   <span class="cm">/* ... expects ... */</span>
</span><span class='line'>   <span class="n">replay</span><span class="o">(</span><span class="n">something</span><span class="o">,</span> <span class="k">else</span><span class="o">);</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'>   <span class="n">verify</span><span class="o">(</span><span class="n">something</span><span class="o">,</span> <span class="k">else</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And I refactor it to be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Something</span> <span class="n">something</span> <span class="o">=</span> <span class="n">createMock</span><span class="o">(</span><span class="n">Something</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>   <span class="n">Else</span> <span class="k">else</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Else</span><span class="o">();</span>
</span><span class='line'>   <span class="cm">/* ... expects ... */</span>
</span><span class='line'>   <span class="n">replay</span><span class="o">(</span><span class="n">something</span><span class="o">,</span> <span class="k">else</span><span class="o">);</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'>   <span class="n">verify</span><span class="o">(</span><span class="n">something</span><span class="o">,</span> <span class="k">else</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Explanation</h4>

<p>I changed the Else class to not be a mock object for the test.  But, I forgot to remove the reference to else from the replay() and verify() methods  (statically imported EasyMock methods).  So, this RuntimeExceptionWrapper exception makes no sense, but I have had it thrown many times for this reason.  To fix it, remove the non-mocks from the mock-related methods.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Something</span> <span class="n">something</span> <span class="o">=</span> <span class="n">createMock</span><span class="o">(</span><span class="n">Something</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>   <span class="n">Else</span> <span class="k">else</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Else</span><span class="o">();</span>
</span><span class='line'>   <span class="cm">/* ... expects ... */</span>
</span><span class='line'>   <span class="n">replay</span><span class="o">(</span><span class="n">something</span><span class="o">);</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'>   <span class="n">verify</span><span class="o">(</span><span class="n">something</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Last Call for Mocks</h3>

<h4>Exception</h4>

<p>Again, I believe I may have seen this exception in more than one type of situation.  This is just one.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalStateException</span><span class="o">:</span> <span class="n">no</span> <span class="n">last</span> <span class="n">call</span> <span class="n">on</span> <span class="n">a</span> <span class="n">mock</span> <span class="n">available</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">EasyMock</span><span class="o">.</span><span class="na">getControlForLastCall</span><span class="o">(</span><span class="n">EasyMock</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">174</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">EasyMock</span><span class="o">.</span><span class="na">expectLastCall</span><span class="o">(</span><span class="n">EasyMock</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">167</span><span class="o">)</span>
</span><span class='line'>  <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Behavior</h4>

<p>I use IntelliJ IDEA, which I love for many reasons.  One of them is it&#8217;s robust refactoring toolset.  For instance, Ctrl-Alt-V, by default, is the introduce variable shortcut.  So, you select the expression that returns some value, introduce variable, and voila, that return value is stored in a nice local variable for you (or there are other options to refactor into fields, constants, parameters, and such.  End shameless plug.  Anywho, EasyMock scenarios value ordering of method calls.  This can become problematic if you&#8217;re not careful to maintain its delicate order needs (which a refactoring tool, for instance, knows nothing about).</p>

<p>If I start with this as a part of a test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">someObj</span><span class="o">.</span><span class="na">doSomething</span><span class="o">();</span>
</span><span class='line'><span class="n">expectLastCall</span><span class="o">().</span><span class="na">andThrow</span><span class="o">(</span><span class="k">new</span> <span class="n">Exception</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then somehow came to this, let&#8217;s assume for the sake of a refactor:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">someObj</span><span class="o">.</span><span class="na">doSomething</span><span class="o">();</span>
</span><span class='line'><span class="n">Exception</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Exception</span><span class="o">();</span>
</span><span class='line'><span class="n">expectLastCall</span><span class="o">().</span><span class="na">andThrow</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will get the above exception.</p>

<h4>Explanation</h4>

<p>Simply, the problem is that something has been interjected in between the method call and the expect.  Because these things are syntatically separate with the void return type methods, this becomes a possible pitfall.  To fix, put the two together, keep the ordering correct.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Exception</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Exception</span><span class="o">();</span>
</span><span class='line'><span class="n">someObj</span><span class="o">.</span><span class="na">doSomething</span><span class="o">();</span>
</span><span class='line'><span class="n">expectLastCall</span><span class="o">().</span><span class="na">andThrow</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Throws like a girl</h3>

<h4>Exception</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalArgumentException</span><span class="o">:</span> <span class="n">last</span> <span class="n">method</span> <span class="n">called</span> <span class="n">on</span> <span class="n">mock</span> <span class="n">cannot</span> <span class="k">throw</span> <span class="n">com</span><span class="o">.</span><span class="na">lowagie</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">DocumentException</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">MocksControl</span><span class="o">.</span><span class="na">andThrow</span><span class="o">(</span><span class="n">MocksControl</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">137</span><span class="o">)</span>
</span><span class='line'>   <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Behavior</h4>

<p>When I&#8217;m trying to test the catch blocks in my code, often times I will simulate an exception being thrown with the mock andThrow() method.  If I start with a class like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Something</span> <span class="o">{</span>
</span><span class='line'>   <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>         <span class="n">externalService</span><span class="o">.</span><span class="na">callService</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="c1">// log </span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">interface</span> <span class="nc">ExternalService</span> <span class="o">{</span>
</span><span class='line'>   <span class="kt">void</span> <span class="nf">callService</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And do a test like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDoSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'>   <span class="n">externalService</span><span class="o">.</span><span class="na">callService</span><span class="o">();</span>
</span><span class='line'>   <span class="n">expectLastCall</span><span class="o">().</span><span class="na">andThrow</span><span class="o">(</span><span class="k">new</span> <span class="n">Exception</span><span class="o">());</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You are likely to get the above problematic exception.</p>

<h4>Explanation</h4>

<p>Sure you catch the exception; sure you want to check your catch block logic (lame here); but andThrow() needs to know that it&#8217;s doing the right thing.  Expectations in mocks are really quite flexible and allow us to make the code do things it might not otherwise do through simulated conditions in a test.  But, EasyMock will not do the impossible.  And in this case, it knows that if you&#8217;re expecting a checked exception to be thrown, it must be declared as thrown, which it is not.  So, to fix this, your code must actually declare that it throws Exception.  Of course, only do this if it makes sense.  And, if it doesn&#8217;t, why are you testing it anyway?</p>

<p>For interface and implementing class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">callService</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Half-Mocked Expectations</h3>

<h4>Exception</h4>

<p>This exception is very similar to that mentioned in the &#8221;<a href="#mocksusemocks">Mock methods use Mocks</a>&#8221; section above.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalStateException</span><span class="o">:</span> <span class="kt">void</span> <span class="n">method</span> <span class="n">cannot</span> <span class="k">return</span> <span class="n">a</span> <span class="n">value</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">MocksControl</span><span class="o">.</span><span class="na">andReturn</span><span class="o">(</span><span class="n">MocksControl</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">128</span><span class="o">)</span>
</span><span class='line'>   <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Behavior</h4>

<p>It is convenient and more unit-like to test one method in a class that calls other methods in that class but not test the other method at that point.  Thus, we half-mock the class, mocking the &#8220;external&#8221; methods, the ones not being tested in this particular test, but not mocking the method being tested.  Did I mention how useful this is?  Let&#8217;s try it.</p>

<p>Start with this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestMe</span> <span class="o">{</span>
</span><span class='line'>   <span class="kt">void</span> <span class="nf">doTestNow</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="cm">/* ... */</span>
</span><span class='line'>      <span class="n">doTestLater</span><span class="o">();</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And this test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDoTestNow</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">NoSuchMethodException</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">Method</span> <span class="n">doTestLater</span> <span class="o">=</span> <span class="n">TestMe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&quot;doTestLater&quot;</span><span class="o">);</span>
</span><span class='line'>   <span class="n">TestMe</span> <span class="n">me</span> <span class="o">=</span> <span class="n">createMock</span><span class="o">(</span><span class="n">TestMe</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">doTestLater</span><span class="o">);</span>
</span><span class='line'>   <span class="cm">/* ... */</span>
</span><span class='line'>   <span class="n">me</span><span class="o">.</span><span class="na">doTestLater</span><span class="o">();</span>
</span><span class='line'>   <span class="n">expectLastCall</span><span class="o">();</span>
</span><span class='line'>   <span class="n">replay</span><span class="o">(</span><span class="n">me</span><span class="o">);</span>
</span><span class='line'>   <span class="n">me</span><span class="o">.</span><span class="na">doTestNow</span><span class="o">();</span>
</span><span class='line'>   <span class="n">verify</span><span class="o">(</span><span class="n">me</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we instantiate TestMe, it looks like a mock, but when we pass in var-arg java.lang.reflect.Method parameters, only those specified methods are mocked.  This works, is cool, and allows the doTestNow() method to be tested independent of the doTestLater() method and its test.  Now, let us pretend that we change our test to not want to mock calls to methods on TestMe, and instead of doing this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">TestMe</span> <span class="n">me</span> <span class="o">=</span> <span class="n">createMock</span><span class="o">(</span><span class="n">TestMe</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">doTestLater</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>We do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">TestMe</span> <span class="n">me</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestMe</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will get the icky exception shown above.</p>

<h4>Explanation</h4>

<p>The first thing we tried to do worked, but the reason we got the exception that we&#8217;re decrypting is because we made the refactor to the test, making the TestMe instance totally non-mocked, but we left the expectLastCall() on the me.doTestLater() call.  Simply remove that expectation and you&#8217;re good to go again.  Just remember, now you&#8217;re actually calling into the body of doTestLater().</p>

<p>Well, that&#8217;s it for this current round into the EasyMock foray.  But, I&#8217;m sure to continue to make mistakes using this helpful, yet often-problematic tool that is EasyMock.  If you have any cause-effect mappings related EasyMock that might help, let us know.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jake Trent</span></span>

      








  


<time datetime="2009-07-06T09:36:00-06:00" pubdate data-updated="true">Jul 6<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/code/'>Code</a>, <a class='category' href='/blog/categories/easymock/'>easymock</a>, <a class='category' href='/blog/categories/java/'>java</a>, <a class='category' href='/blog/categories/unit-testing/'>unit-testing</a>
  
</span>


    </p>
    
      <div class="sharing"></div>

    
    <p class="meta">
      
        <a class="prev-article-link" href="/post/expose-fields-java-reflection/" title="Previous Post: Expose Fields via Java Reflection">&laquo; Expose Fields via Java Reflection</a>
      
      
        <a class="next-article-link" href="/post/release-it-stability-review/" title="Next Post: Release It! Stability Review">Release It! Stability Review &raquo;</a>
      
    </p>
  </footer>
</article>

  <section class="comments">
    <h2 class="comments-title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

    </div>
  </div>
  <div class="container">
    <footer class="main-footer" role="contentinfo"><p>
  <a href="http://creativecommons.org/licenses/by/3.0/us/">CC 3.0 Attribution</a> 2014 -
  <a href="https://plus.google.com/115032056022257436849?rel=author">Jake Trent</a> -
  <a href="/atom.xml">Feed</a>
  <span class="main-footer-extras">-
    <a href="/sitemap.xml">Sitemap</a> -
    <a href="https://github.com/jaketrent/jaketrent-blog/issues">Report a Bug</a> -
    <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  </span>
</p>

</footer>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'jaketrent';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://jaketrent.com/post/easymock-cause-effect-exception-mapping/';
        var disqus_url = 'http://jaketrent.com/post/easymock-cause-effect-exception-mapping/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>
